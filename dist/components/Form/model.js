import{__awaiter as e,__assign as t,__generator as r}from"../../node_modules/tslib/tslib.es6.js";import o from"lodash-es/merge";import{useState as i,useEffect as n}from"react";import{notUndefined as u}from"./validators.js";import{defaultFormValidationResult as s,defaultFormOptions as a}from"./common.js";import l from"../../hooks/useRerender/useRerender.js";import{isPromise as f}from"../../utils/TypeHelper/TypeHelper.js";var h=function(){function i(e){this.formDef={},this.isTouched$=!1,this.validationResult$=s,this.formDef=t(t({},e),{options:o(a,e)}),this.reset()}return Object.defineProperty(i.prototype,"validationResult",{get:function(){return this.validationResult$},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"isTouched",{get:function(){return this.isTouched$||Object.values(this.value).some((function(e){return e instanceof i&&e.isTouched}))},enumerable:!1,configurable:!0}),i.prototype.setValue=function(e){return this.value=this.makeValueProxy(e),this.performChanges(this.value),this.value},i.prototype.reset=function(){var e,t;this.isTouched$=!1,this.validationResult$=s,this.formDef.initialValue?this.value=this.makeValueProxy(this.formDef.initialValue):this.value=this.makeValueProxy({}),this.resetChildForms(),null===(t=(e=this.formDef).onChange)||void 0===t||t.call(e,this.value)},i.prototype.validate=function(){return e(this,void 0,void 0,(function(){var o,n,u=this;return r(this,(function(s){return o=Object.entries(this.value).map((function(e){var t,r=e[0],o=e[1];return o instanceof i?Promise.resolve([r,o.validate()]):(null===(t=u.formDef.rules)||void 0===t?void 0:t[r])?Promise.resolve([r,u.formDef.rules[r](o)]):Promise.resolve([r,!0])})),n=function(o){return Promise.all(o).then((function(t){return e(void 0,void 0,void 0,(function(){return r(this,(function(o){return[2,Promise.all(t.map((function(t){return e(void 0,void 0,void 0,(function(){var e;return r(this,(function(r){switch(r.label){case 0:return f(t[1])?[4,t[1]]:[3,2];case 1:return e=r.sent(),[2,[t[0],e]];case 2:return[2,t]}}))}))})))]}))}))})).then((function(e){return{isValid:e.every((function(e){var t=e[1];return"object"==typeof t?t.isValid:t})),result:e.reduce((function(e,r){var o;return t(t({},e),((o={})[r[0]]=r[1],o))}),{})}}))}(o),n.then((function(e){var t,r;u.isTouched$=!0,u.validationResult$=e,null===(r=(t=u.formDef).onChange)||void 0===r||r.call(t,u.value)})),[2,n]}))}))},i.prototype.hasError=function(e){return!!this.isTouched&&(!!u(this.validationResult.result[e])&&!this.validationResult.result[e])},i.prototype.resetChildForms=function(){Object.values(this.value).forEach((function(e){e instanceof i&&e.reset()}))},i.prototype.makeValueProxy=function(e){var r=this,o={get:function(e,t){return e[t]},set:function(e,t,o){return e[t]=o,function(e){r.performChanges(e)}(e),!0}};return new Proxy(t({},e),o)},i.prototype.performChanges=function(e){var t,r,o;this.isTouched$=!0,null===(r=(t=this.formDef).onChange)||void 0===r||r.call(t,e),(null===(o=this.formDef.options)||void 0===o?void 0:o.validateOnChange)&&this.validate()},i}(),c=function(e){return new h(e)},v=function(e){var r=l().rerender,o=i(),u=o[0],s=o[1];return n((function(){s(c(t(t({},e),{onChange:function(t){var o;null===(o=e.onChange)||void 0===o||o.call(e,t),r()}})))}),[e,r]),u};export{h as VirtualForm,c as defineForm,v as useForm};
//# sourceMappingURL=model.js.map
